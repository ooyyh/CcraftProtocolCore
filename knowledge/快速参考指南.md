# Minecraft 1.8.9 åè®®å®ç° - å¿«é€Ÿå‚è€ƒæŒ‡å—

## æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥

### 1. VarInt ç¼–ç 

**ä½œç”¨**: å¯å˜é•¿åº¦æ•´æ•°ç¼–ç ,èŠ‚çœç©ºé—´

**ç¼–ç è§„åˆ™**:
- æ¯ä¸ªå­—èŠ‚çš„æœ€é«˜ä½è¡¨ç¤ºæ˜¯å¦è¿˜æœ‰åç»­å­—èŠ‚
- å…¶ä½™7ä½å­˜å‚¨å®é™…æ•°æ®

**ä»£ç **:
```java
// å†™å…¥
while ((value & -128) != 0) {
    output.writeByte(value & 127 | 128);
    value >>>= 7;
}
output.writeByte(value);

// è¯»å–
int value = 0, position = 0;
byte currentByte;
while (true) {
    currentByte = input.readByte();
    value |= (currentByte & 127) << position;
    if ((currentByte & 128) == 0) break;
    position += 7;
}
```

### 2. æ•°æ®åŒ…æ ¼å¼

**åŸºæœ¬æ ¼å¼**:
```
[æ•°æ®åŒ…é•¿åº¦(VarInt)] [æ•°æ®åŒ…ID(VarInt)] [æ•°æ®å†…å®¹]
```

**å‹ç¼©æ ¼å¼**:
```
[æ•°æ®åŒ…é•¿åº¦(VarInt)] [æœªå‹ç¼©é•¿åº¦(VarInt)] [å‹ç¼©åçš„æ•°æ®]
```

### 3. åè®®çŠ¶æ€

```
HANDSHAKING (0) â†’ STATUS (1) æˆ– LOGIN (2) â†’ PLAY (3)
```

**çŠ¶æ€è¯´æ˜**:
- HANDSHAKING: åˆå§‹æ¡æ‰‹
- STATUS: æœåŠ¡å™¨åˆ—è¡¨æŸ¥è¯¢
- LOGIN: ç™»å½•æµç¨‹
- PLAY: æ¸¸æˆä¸­

### 4. æ•°æ®ç±»å‹å¯¹ç…§è¡¨

| Minecraft ç±»å‹ | Java ç±»å‹ | å­—èŠ‚æ•° | è¯´æ˜ |
|---------------|----------|--------|------|
| VarInt | int | 1-5 | å¯å˜é•¿åº¦æ•´æ•° |
| String | String | å˜é•¿ | VarInté•¿åº¦ + UTF-8å­—èŠ‚ |
| Byte | byte | 1 | æœ‰ç¬¦å·å­—èŠ‚ |
| Unsigned Byte | int | 1 | æ— ç¬¦å·å­—èŠ‚ (0-255) |
| Short | short | 2 | æœ‰ç¬¦å·çŸ­æ•´æ•° |
| Unsigned Short | int | 2 | æ— ç¬¦å·çŸ­æ•´æ•° (0-65535) |
| Int | int | 4 | æœ‰ç¬¦å·æ•´æ•° |
| Long | long | 8 | æœ‰ç¬¦å·é•¿æ•´æ•° |
| Float | float | 4 | å•ç²¾åº¦æµ®ç‚¹æ•° |
| Double | double | 8 | åŒç²¾åº¦æµ®ç‚¹æ•° |
| Boolean | boolean | 1 | å¸ƒå°”å€¼ (0æˆ–1) |
| UUID | UUID | 16 | ä¸¤ä¸ª long |

## å¸¸ç”¨æ•°æ®åŒ…é€ŸæŸ¥

### Handshake é˜¶æ®µ

**PacketHandshake (0x00)**
```java
// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
int protocolVersion;  // 47 (Minecraft 1.8.9)
String serverAddress; // æœåŠ¡å™¨åœ°å€
int serverPort;       // æœåŠ¡å™¨ç«¯å£
int nextState;        // 1=STATUS, 2=LOGIN
```

### Login é˜¶æ®µ

**PacketLoginStart (0x00)**
```java
// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
String username;      // ç©å®¶åç§°
```

**PacketEncryptionRequest (0x01)**
```java
// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
String serverId;      // æœåŠ¡å™¨ID (é€šå¸¸ä¸ºç©º)
byte[] publicKey;     // RSA å…¬é’¥
byte[] verifyToken;   // éªŒè¯ä»¤ç‰Œ
```

**PacketEncryptionResponse (0x01)**
```java
// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
byte[] sharedSecret;  // åŠ å¯†çš„å…±äº«å¯†é’¥
byte[] verifyToken;   // åŠ å¯†çš„éªŒè¯ä»¤ç‰Œ
```

**PacketSetCompression (0x03)**
```java
// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
int threshold;        // å‹ç¼©é˜ˆå€¼
```

**PacketLoginSuccess (0x02)**
```java
// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
String uuid;          // ç©å®¶ UUID
String username;      // ç©å®¶åç§°
```

### Play é˜¶æ®µ

**PacketKeepAlive (0x00)**
```java
// åŒå‘
int keepAliveId;      // KeepAlive ID
```

**PacketJoinGame (0x01)**
```java
// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
int entityId;         // ç©å®¶å®ä½“ID
int gamemode;         // æ¸¸æˆæ¨¡å¼
int dimension;        // ç»´åº¦
int difficulty;       // éš¾åº¦
int maxPlayers;       // æœ€å¤§ç©å®¶æ•°
String levelType;     // ä¸–ç•Œç±»å‹
boolean reducedDebugInfo; // å‡å°‘è°ƒè¯•ä¿¡æ¯
```

**PacketChatMessage (0x02)**
```java
// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
String message;       // èŠå¤©æ¶ˆæ¯ (JSONæ ¼å¼)
byte position;        // ä½ç½® (0=èŠå¤©, 1=ç³»ç»Ÿ, 2=å¿«æ·æ )
```

**PacketPlayerPosition (0x04)**
```java
// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
double x;             // X åæ ‡
double y;             // Y åæ ‡
double z;             // Z åæ ‡
boolean onGround;     // æ˜¯å¦åœ¨åœ°é¢
```

**PacketPlayerPositionAndLook (0x06 å®¢æˆ·ç«¯, 0x08 æœåŠ¡å™¨)**
```java
// åŒå‘
double x;             // X åæ ‡
double y;             // Y åæ ‡
double z;             // Z åæ ‡
float yaw;            // åèˆªè§’
float pitch;          // ä¿¯ä»°è§’
byte flags;           // æ ‡å¿—ä½ (æœåŠ¡å™¨â†’å®¢æˆ·ç«¯)
boolean onGround;     // æ˜¯å¦åœ¨åœ°é¢ (å®¢æˆ·ç«¯â†’æœåŠ¡å™¨)
```

**PacketClientSettings (0x15)**
```java
// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
String locale;        // è¯­è¨€ (å¦‚ "en_US")
byte viewDistance;    // è§†è·
byte chatMode;        // èŠå¤©æ¨¡å¼
boolean chatColors;   // èŠå¤©é¢œè‰²
int displayedSkinParts; // æ˜¾ç¤ºçš„çš®è‚¤éƒ¨åˆ†
```

**PacketDisconnect (0x40)**
```java
// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
String reason;        // æ–­å¼€åŸå›  (JSONæ ¼å¼)
```

## å®Œæ•´è¿æ¥æµç¨‹

### 1. è¿æ¥åˆ°æœåŠ¡å™¨

```java
// åˆ›å»ºè¿æ¥
MinecraftConnection connection = new MinecraftConnection("localhost", 25565);

// å‘é€ Handshake
PacketHandshake handshake = new PacketHandshake(47, "localhost", 25565, 2);
connection.sendPacket(handshake);
connection.setState(ProtocolState.LOGIN);

// å‘é€ LoginStart
PacketLoginStart loginStart = new PacketLoginStart("TestBot");
connection.sendPacket(loginStart);
```

### 2. å¤„ç†ç™»å½•

```java
while (connection.getState() == ProtocolState.LOGIN) {
    Packet packet = connection.receivePacket();

    if (packet instanceof PacketEncryptionRequest) {
        // å¤„ç†åŠ å¯†
        PacketEncryptionRequest request = (PacketEncryptionRequest) packet;
        handleEncryption(connection, request);
    }
    else if (packet instanceof PacketSetCompression) {
        // å¯ç”¨å‹ç¼©
        PacketSetCompression compression = (PacketSetCompression) packet;
        connection.setCompressionThreshold(compression.getThreshold());
    }
    else if (packet instanceof PacketLoginSuccess) {
        // ç™»å½•æˆåŠŸ
        connection.setState(ProtocolState.PLAY);
        break;
    }
    else if (packet instanceof PacketLoginDisconnect) {
        // ç™»å½•å¤±è´¥
        PacketLoginDisconnect disconnect = (PacketLoginDisconnect) packet;
        System.out.println("ç™»å½•å¤±è´¥: " + disconnect.getReason());
        return;
    }
}
```

### 3. å¤„ç†æ¸¸æˆæ•°æ®åŒ…

```java
// å‘é€å®¢æˆ·ç«¯è®¾ç½®
PacketClientSettings settings = new PacketClientSettings("en_US", (byte)10, (byte)0, true, 127);
connection.sendPacket(settings);

// ä¸»å¾ªç¯
while (connection.isConnected()) {
    Packet packet = connection.receivePacket();

    if (packet instanceof PacketJoinGame) {
        PacketJoinGame joinGame = (PacketJoinGame) packet;
        System.out.println("åŠ å…¥æ¸¸æˆ! Entity ID: " + joinGame.getEntityId());
    }
    else if (packet instanceof PacketPlayerPositionAndLook) {
        PacketPlayerPositionAndLook posLook = (PacketPlayerPositionAndLook) packet;
        // å›å¤ä½ç½®
        PacketPlayerPositionAndLookClient response =
            new PacketPlayerPositionAndLookClient(
                posLook.getX(), posLook.getY(), posLook.getZ(),
                posLook.getYaw(), posLook.getPitch(), true
            );
        connection.sendPacket(response);
    }
    else if (packet instanceof PacketKeepAlive) {
        PacketKeepAlive keepAlive = (PacketKeepAlive) packet;
        // ç«‹å³å›å¤
        connection.sendPacket(new PacketKeepAlive(keepAlive.getKeepAliveId()));
    }
    else if (packet instanceof PacketChatMessage) {
        PacketChatMessage chat = (PacketChatMessage) packet;
        System.out.println("èŠå¤©: " + chat.getMessage());
    }
    else if (packet instanceof PacketDisconnect) {
        PacketDisconnect disconnect = (PacketDisconnect) packet;
        System.out.println("æ–­å¼€è¿æ¥: " + disconnect.getReason());
        break;
    }
}
```

## åŠ å¯†å®ç°

### 1. ç”Ÿæˆå¯†é’¥

```java
// ç”Ÿæˆ RSA å¯†é’¥å¯¹
KeyPairGenerator keyGen = KeyPairGenerator.getInstance("RSA");
keyGen.initialize(1024);
KeyPair keyPair = keyGen.generateKeyPair();

// ç”Ÿæˆ AES å…±äº«å¯†é’¥
KeyGenerator keyGen = KeyGenerator.getInstance("AES");
keyGen.init(128);
SecretKey sharedSecret = keyGen.generateKey();
```

### 2. RSA åŠ å¯†

```java
// åŠ å¯†
Cipher cipher = Cipher.getInstance("RSA");
cipher.init(Cipher.ENCRYPT_MODE, publicKey);
byte[] encrypted = cipher.doFinal(data);

// è§£å¯†
cipher.init(Cipher.DECRYPT_MODE, privateKey);
byte[] decrypted = cipher.doFinal(encrypted);
```

### 3. AES åŠ å¯†æµ

```java
// åˆ›å»º Cipher
Cipher cipher = Cipher.getInstance("AES/CFB8/NoPadding");
cipher.init(Cipher.ENCRYPT_MODE, sharedSecret,
    new IvParameterSpec(sharedSecret.getEncoded()));

// åŒ…è£…æµ
OutputStream encryptedOutput = new CipherOutputStream(rawOutput, cipher);
InputStream encryptedInput = new CipherInputStream(rawInput, cipher);
```

## å‹ç¼©å®ç°

### å‹ç¼©

```java
Deflater deflater = new Deflater();
deflater.setInput(data);
deflater.finish();

ByteArrayOutputStream compressed = new ByteArrayOutputStream();
byte[] buffer = new byte[8192];
while (!deflater.finished()) {
    int count = deflater.deflate(buffer);
    compressed.write(buffer, 0, count);
}
deflater.end();
```

### è§£å‹ç¼©

```java
Inflater inflater = new Inflater();
inflater.setInput(compressed);

byte[] uncompressed = new byte[uncompressedSize];
inflater.inflate(uncompressed);
inflater.end();
```

## å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### 1. "Bad packet id"

**åŸå› **: æ•°æ®åŒ…IDä¸æ­£ç¡®æˆ–æ•°æ®åŒ…æ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ•°æ®åŒ…IDæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æ•°æ®åŒ…å­—æ®µé¡ºåº
- ç¡®è®¤åè®®ç‰ˆæœ¬åŒ¹é…

### 2. "Connection refused"

**åŸå› **: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥ç«¯å£å·æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### 3. "Failed to verify username"

**åŸå› **: æœåŠ¡å™¨å¼€å¯äº†åœ¨çº¿æ¨¡å¼

**è§£å†³æ–¹æ¡ˆ**:
- è®¾ç½® `online-mode=false` åœ¨ server.properties
- æˆ–å®ç° Mojang è´¦æˆ·éªŒè¯

### 4. EOFException

**åŸå› **: è¿æ¥æ„å¤–å…³é—­

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ˜¯å¦æ­£ç¡®å“åº” KeepAlive
- æ£€æŸ¥æ•°æ®åŒ…æ ¼å¼æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

### 5. å‹ç¼©/è§£å‹ç¼©å¤±è´¥

**åŸå› **: å‹ç¼©æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥å‹ç¼©é˜ˆå€¼è®¾ç½®
- ç¡®è®¤æœªå‹ç¼©é•¿åº¦æ­£ç¡®
- æ£€æŸ¥ zlib å®ç°

## è°ƒè¯•æŠ€å·§

### 1. æ‰“å°æ•°æ®åŒ…

```java
public void sendPacket(Packet packet) throws IOException {
    System.out.println("å‘é€: " + packet.getClass().getSimpleName() +
                      " (ID: 0x" + Integer.toHexString(packet.getPacketId()) + ")");
    // ... å‘é€é€»è¾‘
}

public Packet receivePacket() throws IOException {
    Packet packet = ...;
    if (packet != null) {
        System.out.println("æ¥æ”¶: " + packet.getClass().getSimpleName() +
                          " (ID: 0x" + Integer.toHexString(packet.getPacketId()) + ")");
    }
    return packet;
}
```

### 2. æ‰“å°å­—èŠ‚æ•°æ®

```java
public static void printBytes(byte[] data) {
    for (byte b : data) {
        System.out.print(String.format("%02X ", b & 0xFF));
    }
    System.out.println();
}
```

### 3. ä½¿ç”¨ Wireshark

1. å¯åŠ¨ Wireshark
2. æ•è· Loopback æ¥å£
3. è¿‡æ»¤å™¨: `tcp.port == 25565`
4. åˆ†ææ•°æ®åŒ…å†…å®¹

### 4. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

```
logs/latest.log
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å†²åŒºå¤§å°

```java
// å¢å¤§ç¼“å†²åŒº
socket.setSendBufferSize(65536);
socket.setReceiveBufferSize(65536);
```

### 2. TCP_NODELAY

```java
// ç¦ç”¨ Nagle ç®—æ³•,å‡å°‘å»¶è¿Ÿ
socket.setTcpNoDelay(true);
```

### 3. å¯¹è±¡æ± 

```java
// é‡ç”¨ PacketBuffer å¯¹è±¡
private final Queue<PacketBuffer> bufferPool = new ConcurrentLinkedQueue<>();

public PacketBuffer getBuffer() {
    PacketBuffer buffer = bufferPool.poll();
    return buffer != null ? buffer : new PacketBuffer();
}

public void releaseBuffer(PacketBuffer buffer) {
    buffer.clear();
    bufferPool.offer(buffer);
}
```

## æ‰©å±•åŠŸèƒ½

### 1. è‡ªåŠ¨é‡è¿

```java
public void connectWithRetry(String host, int port, int maxRetries) {
    for (int i = 0; i < maxRetries; i++) {
        try {
            connect(host, port);
            return;
        } catch (IOException e) {
            System.out.println("è¿æ¥å¤±è´¥,é‡è¯• " + (i + 1) + "/" + maxRetries);
            Thread.sleep(5000);
        }
    }
    throw new IOException("è¿æ¥å¤±è´¥,å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°");
}
```

### 2. å¿ƒè·³æ£€æµ‹

```java
private long lastKeepAlive = System.currentTimeMillis();

public void checkTimeout() {
    if (System.currentTimeMillis() - lastKeepAlive > 30000) {
        System.out.println("è¿æ¥è¶…æ—¶");
        disconnect();
    }
}
```

### 3. æ•°æ®åŒ…é˜Ÿåˆ—

```java
private final Queue<Packet> packetQueue = new ConcurrentLinkedQueue<>();

public void queuePacket(Packet packet) {
    packetQueue.offer(packet);
}

public void flushPackets() throws IOException {
    Packet packet;
    while ((packet = packetQueue.poll()) != null) {
        sendPacket(packet);
    }
}
```

## å‚è€ƒèµ„æ–™

**å®˜æ–¹æ–‡æ¡£**:
- [Minecraft Protocol Wiki](https://wiki.vg/Protocol)
- [Protocol Version 47](https://wiki.vg/index.php?title=Protocol&oldid=7368)
- [Data Types](https://wiki.vg/Data_types)

**å·¥å…·**:
- [Wireshark](https://www.wireshark.org/) - ç½‘ç»œæŠ“åŒ…
- [IntelliJ IDEA](https://www.jetbrains.com/idea/) - Java IDE
- [Minecraft 1.8.9](https://mcversions.net/) - å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨

**ç›¸å…³é¡¹ç›®**:
- [MCProtocolLib](https://github.com/Steveice10/MCProtocolLib)
- [Netty](https://netty.io/) - ç½‘ç»œæ¡†æ¶

---

**ç¥ä½ å¼€å‘é¡ºåˆ©!** ğŸ®
